#!/bin/sh

restartfile="/var/run/need-system-restart"
lockfile="/var/lock/scheduled-restart.lock"

gui_text_de="Softwareaktualisierungen wurden installiert. Bitte starten Sie das System neu."

gui_text="$gui_text_de"

die()
{
	echo "$*" >&2
	exit 1
}

do_restart()
{
	shutdown -r now || die "Failed to reboot"
}

export TERM=linux
export PATH="/usr/local/sbin:/usr/sbin:/sbin:/usr/local/bin:/usr/bin:/bin"
export DISPLAY=:0.0

( flock -x -n 9 || die "Failed to acquire lock"
	exec 2>&1

	if [ -e "$restartfile" ]; then
		if [ "$1" = "gui" ]; then
			zenity --notification \
				--timeout=60 \
				--window-icon=warning \
				--text "$gui_text"
		else
			do_restart
		fi
	fi
) 9> "$lockfile" | logger -p daemon.err -t scheduled-restart

exit 0

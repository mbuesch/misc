#!/bin/sh

aria2c_jobs=16
listfile=

die()
{
	echo "$*" >&2
	exit 1
}

info()
{
	echo "--- $*"
}

cleanup()
{
	[ -f "$listfile" ] && {
		rm "$listfile"
		listfile=
	}
}

usage()
{
	echo "update [OPTIONS]"
	echo
	echo "Options:"
	echo " -p|--parallel          Parallel download"
	echo " -f|--full              Full upgrade"
	echo " -d|--download-only     Download only"
	echo " -c|--checkrestart      Run checkrestart"
}

trap cleanup INT EXIT

parallel=0
full=0
download_only=0
checkrestart=0

while [ $# -ge 1 ]; do
	case "$1" in
	-p|--parallel)
		parallel=1
		;;
	-f|--full)
		full=1
		;;
	-d|--download-only)
		download_only=1
		;;
	-c|--checkrestart)
		checkrestart=1
		;;
	-h|--help)
		usage
		exit 0
		;;
	*)
		die "Unknown parameter: $1"
		;;
	esac
	shift
done

[ $full -eq 0 ] && {
	upgrade_mode="upgrade"
} || {
	upgrade_mode="dist-upgrade"
}


info "Updating package list"
apt-get update || die "Update failed"

# Run parallel download, if requested.
if [ $parallel -ne 0 ]; then
	info "Generating package list for '$upgrade_mode'"
	listfile="$(mktemp --tmpdir=/tmp update-files.list.XXXXXXXX)"
	[ -w "$listfile" ] || die "Failed to create temporary file"
	apt-uri-list "$upgrade_mode" | apturi2metalink > "$listfile" ||\
		die "Failed to generate file list"

	info "Downloading packages"
	while ! aria2c -j "$aria2c_jobs" -s "$aria2c_jobs" -x "$aria2c_jobs" \
			-t 120 -k 1048576 \
			--retry-wait=1 -d /var/cache/apt/archives/ \
			"$listfile"; do
		sleep 10
	done
fi

# Check whether a kernel image will be installed/updated.
kernel_updated=0
apt-get --show-upgraded --verbose-versions --dry-run "$upgrade_mode" |\
	grep -qEe '^[[:space:]]*linux-image-[[:digit:]]' &&\
	kernel_updated=1

# Do the download and upgrade.
info "Performing '$upgrade_mode'"
dl_flags=
[ $download_only -ne 0 ] && dl_flags="--download-only"
apt-get $dl_flags --show-upgraded "$upgrade_mode" || die "Upgrade failed"

# Exit here, if download only.
[ $download_only -ne 0 ] && exit 0

# Purge packages, if full upgrade.
[ $full -ne 0 ] && {
	info "Purging old packages"
	apt-get autoremove --purge || die "Autoremove failed"
}

info "Cleaning"
apt-get clean || die "Clean failed"

# Run checkrestart, if requested.
[ $checkrestart -ne 0 ] && which checkrestart >/dev/null 2>&1 && {
	info "Running checkrestart"
	blacklist=
	[ -r /etc/checkrestart.blacklist ] && blacklist="-b /etc/checkrestart.blacklist"
	checkrestart $blacklist || die "checkrestart failed"
}

[ $kernel_updated -ne 0 ] && info "The kernel has been updated!"

exit 0
